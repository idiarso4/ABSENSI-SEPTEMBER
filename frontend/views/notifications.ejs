<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pemberitahuan - HRM & Payroll System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-bell"></i> Sistem Pemberitahuan</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createNotificationModal">
                    <i class="bi bi-plus-circle"></i> Buat Pemberitahuan
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#notificationSettingsModal">
                    <i class="bi bi-gear"></i> Pengaturan
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Pemberitahuan</h5>
                        <h3 id="totalNotifications">-</h3>
                        <small>Bulanan</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Belum Dibaca</h5>
                        <h3 id="unreadNotifications">-</h3>
                        <small>Menunggu</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Email Terkirim</h5>
                        <h3 id="sentEmails">-</h3>
                        <small>Bulanan</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Template Aktif</h5>
                        <h3 id="activeTemplates">-</h3>
                        <small>Digunakan</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="notificationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">Semua Pemberitahuan</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="unread-tab" data-bs-toggle="tab" data-bs-target="#unread" type="button" role="tab">Belum Dibaca</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">Template</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">Pengaturan Otomatis</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="notificationTabContent">
            <!-- All Notifications Tab -->
            <div class="tab-pane fade show active" id="all" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Daftar Pemberitahuan</h5>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="notificationTypeFilter" style="width: auto;">
                                    <option value="">Semua Tipe</option>
                                    <option value="system">Sistem</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="announcement">Pengumuman</option>
                                    <option value="email">Email</option>
                                </select>
                                <select class="form-select form-select-sm" id="notificationStatusFilter" style="width: auto;">
                                    <option value="">Semua Status</option>
                                    <option value="sent">Terkirim</option>
                                    <option value="pending">Menunggu</option>
                                    <option value="failed">Gagal</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Tipe</th>
                                        <th>Judul</th>
                                        <th>Penerima</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="notificationsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Memuat...</span>
                                            </div>
                                            Memuat data pemberitahuan...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unread Notifications Tab -->
            <div class="tab-pane fade" id="unread" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5>Pemberitahuan Belum Dibaca</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="unreadNotificationsList">
                            <div class="list-group-item text-center text-muted">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Memuat...</span>
                                </div>
                                Memuat pemberitahuan belum dibaca...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates Tab -->
            <div class="tab-pane fade" id="templates" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5>Template Pemberitahuan</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nama Template</th>
                                        <th>Tipe</th>
                                        <th>Subjek</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="templatesTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Memuat...</span>
                                            </div>
                                            Memuat data template...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5>Pengaturan Pemberitahuan Otomatis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Reminder Cuti</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="leaveReminderEnabled" checked>
                                    <label class="form-check-label" for="leaveReminderEnabled">
                                        Aktifkan reminder cuti mendekati
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <label for="leaveReminderDays" class="form-label">Hari sebelum reminder:</label>
                                    <input type="number" class="form-control" id="leaveReminderDays" value="7" min="1" max="30">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Reminder Ulang Tahun</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="birthdayReminderEnabled" checked>
                                    <label class="form-check-label" for="birthdayReminderEnabled">
                                        Aktifkan reminder ulang tahun
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <label for="birthdayReminderDays" class="form-label">Hari sebelum reminder:</label>
                                    <input type="number" class="form-control" id="birthdayReminderDays" value="1" min="0" max="7">
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h6>Reminder Penilaian Kinerja</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="performanceReminderEnabled" checked>
                                    <label class="form-check-label" for="performanceReminderEnabled">
                                        Aktifkan reminder penilaian kinerja
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <label for="performanceReminderDays" class="form-label">Hari sebelum deadline:</label>
                                    <input type="number" class="form-control" id="performanceReminderDays" value="14" min="1" max="30">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Pengaturan Email</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="emailNotificationsEnabled" checked>
                                    <label class="form-check-label" for="emailNotificationsEnabled">
                                        Aktifkan notifikasi email
                                    </label>
                                </div>
                                <div class="mt-2">
                                    <label for="emailFrequency" class="form-label">Frekuensi pengiriman:</label>
                                    <select class="form-select" id="emailFrequency">
                                        <option value="immediate">Langsung</option>
                                        <option value="daily">Harian</option>
                                        <option value="weekly">Mingguan</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button class="btn btn-primary" id="saveNotificationSettings">
                                <i class="bi bi-save"></i> Simpan Pengaturan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Notification Modal -->
    <div class="modal fade" id="createNotificationModal" tabindex="-1" aria-labelledby="createNotificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createNotificationModalLabel">Buat Pemberitahuan Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notificationType" class="form-label">Tipe Pemberitahuan *</label>
                                    <select class="form-select" id="notificationType" required>
                                        <option value="">Pilih Tipe</option>
                                        <option value="system">Sistem</option>
                                        <option value="reminder">Reminder</option>
                                        <option value="announcement">Pengumuman</option>
                                        <option value="email">Email</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notificationPriority" class="form-label">Prioritas</label>
                                    <select class="form-select" id="notificationPriority">
                                        <option value="normal">Normal</option>
                                        <option value="high">Tinggi</option>
                                        <option value="urgent">Mendesak</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notificationTitle" class="form-label">Judul *</label>
                            <input type="text" class="form-control" id="notificationTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label">Pesan *</label>
                            <textarea class="form-control" id="notificationMessage" rows="4" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notificationRecipients" class="form-label">Penerima</label>
                                    <select class="form-select" id="notificationRecipients">
                                        <option value="all">Semua Karyawan</option>
                                        <option value="department">Per Departemen</option>
                                        <option value="individual">Individual</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notificationSchedule" class="form-label">Jadwalkan Pengiriman</label>
                                    <input type="datetime-local" class="form-control" id="notificationSchedule">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3" id="departmentSelectContainer" style="display: none;">
                            <label for="notificationDepartment" class="form-label">Departemen</label>
                            <select class="form-select" id="notificationDepartment">
                                <option value="">Pilih Departemen</option>
                            </select>
                        </div>
                        <div class="mb-3" id="employeeSelectContainer" style="display: none;">
                            <label for="notificationEmployees" class="form-label">Karyawan</label>
                            <select class="form-select" id="notificationEmployees" multiple>
                                <option value="">Pilih Karyawan</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendEmail" checked>
                            <label class="form-check-label" for="sendEmail">
                                Kirim juga via email
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="sendNotificationBtn">Kirim Pemberitahuan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div class="modal fade" id="notificationSettingsModal" tabindex="-1" aria-labelledby="notificationSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationSettingsModalLabel">Pengaturan Pemberitahuan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>Notifikasi Browser</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="browserNotifications" checked>
                            <label class="form-check-label" for="browserNotifications">
                                Aktifkan notifikasi browser
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Notifikasi Email</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            <label class="form-check-label" for="emailNotifications">
                                Aktifkan notifikasi email
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Notifikasi Desktop</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="desktopNotifications" checked>
                            <label class="form-check-label" for="desktopNotifications">
                                Aktifkan notifikasi desktop
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6>Suara Notifikasi</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="soundNotifications" checked>
                            <label class="form-check-label" for="soundNotifications">
                                Aktifkan suara notifikasi
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Simpan Pengaturan</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function getToken() { return localStorage.getItem('token') || ''; }

        let notifications = [];
        let templates = [];
        let departments = [];
        let employees = [];

        // Logout functionality
        document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('token');
            window.location.href = '/login';
        });

        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (response.ok) {
                    notifications = await response.json();
                    renderNotificationsTable();
                    updateSummary();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/notification-templates', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (response.ok) {
                    templates = await response.json();
                    renderTemplatesTable();
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        async function loadDepartments() {
            try {
                const response = await fetch('/api/departments', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (response.ok) {
                    departments = await response.json();
                    populateDepartmentDropdowns();
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        async function loadEmployees() {
            try {
                const response = await fetch('/api/employees', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (response.ok) {
                    employees = await response.json();
                    populateEmployeeDropdowns();
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        function populateDepartmentDropdowns() {
            const departmentSelects = ['notificationDepartment'];
            departmentSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Pilih Departemen</option>';
                    departments.forEach(dept => {
                        select.add(new Option(dept.name, dept.id));
                    });
                }
            });
        }

        function populateEmployeeDropdowns() {
            const employeeSelects = ['notificationEmployees'];
            employeeSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '';
                    employees.forEach(emp => {
                        const option = new Option(`${emp.firstName} ${emp.lastName}`, emp.id);
                        select.add(option);
                    });
                }
            });
        }

        function renderNotificationsTable() {
            const tableBody = document.getElementById('notificationsTableBody');
            tableBody.innerHTML = '';

            if (!notifications || notifications.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tidak ada data pemberitahuan</td></tr>';
                return;
            }

            notifications.forEach(notification => {
                const statusClass = notification.status === 'sent' ? 'success' : notification.status === 'pending' ? 'warning' : 'danger';
                const statusText = notification.status === 'sent' ? 'Terkirim' : notification.status === 'pending' ? 'Menunggu' : 'Gagal';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(notification.createdAt).toLocaleDateString('id-ID')}</td>
                    <td><span class="badge bg-primary">${notification.type}</span></td>
                    <td>${notification.title}</td>
                    <td>${notification.recipientCount || 'N/A'}</td>
                    <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary view-notification" data-id="${notification.id}" title="Lihat Detail">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info resend-notification" data-id="${notification.id}" title="Kirim Ulang">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            addNotificationActionListeners();
        }

        function renderTemplatesTable() {
            const tableBody = document.getElementById('templatesTableBody');
            tableBody.innerHTML = '';

            if (!templates || templates.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Tidak ada data template</td></tr>';
                return;
            }

            templates.forEach(template => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${template.name}</td>
                    <td><span class="badge bg-primary">${template.type}</span></td>
                    <td>${template.subject}</td>
                    <td><span class="badge bg-success">Aktif</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-warning edit-template" data-id="${template.id}" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info use-template" data-id="${template.id}" title="Gunakan">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            addTemplateActionListeners();
        }

        function updateSummary() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyNotifications = notifications.filter(n =>
                new Date(n.createdAt).getMonth() === currentMonth &&
                new Date(n.createdAt).getFullYear() === currentYear
            );

            const totalNotifications = monthlyNotifications.length;
            const unreadNotifications = monthlyNotifications.filter(n => n.status === 'pending').length;
            const sentEmails = monthlyNotifications.filter(n => n.type === 'email' && n.status === 'sent').length;
            const activeTemplates = templates.length;

            document.getElementById('totalNotifications').textContent = totalNotifications;
            document.getElementById('unreadNotifications').textContent = unreadNotifications;
            document.getElementById('sentEmails').textContent = sentEmails;
            document.getElementById('activeTemplates').textContent = activeTemplates;
        }

        function addNotificationActionListeners() {
            document.querySelectorAll('.view-notification').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const notificationId = e.target.closest('button').dataset.id;
                    viewNotification(notificationId);
                });
            });

            document.querySelectorAll('.resend-notification').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const notificationId = e.target.closest('button').dataset.id;
                    resendNotification(notificationId);
                });
            });
        }

        function addTemplateActionListeners() {
            document.querySelectorAll('.edit-template').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.closest('button').dataset.id;
                    editTemplate(templateId);
                });
            });

            document.querySelectorAll('.use-template').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const templateId = e.target.closest('button').dataset.id;
                    useTemplate(templateId);
                });
            });
        }

        // Dynamic form handling
        document.getElementById('notificationRecipients').addEventListener('change', function() {
            const value = this.value;
            document.getElementById('departmentSelectContainer').style.display = value === 'department' ? 'block' : 'none';
            document.getElementById('employeeSelectContainer').style.display = value === 'individual' ? 'block' : 'none';
        });

        // Form handlers
        document.getElementById('sendNotificationBtn').addEventListener('click', async function() {
            const formData = {
                type: document.getElementById('notificationType').value,
                priority: document.getElementById('notificationPriority').value,
                title: document.getElementById('notificationTitle').value,
                message: document.getElementById('notificationMessage').value,
                recipientType: document.getElementById('notificationRecipients').value,
                departmentId: document.getElementById('notificationDepartment').value,
                employeeIds: Array.from(document.getElementById('notificationEmployees').selectedOptions).map(option => option.value),
                scheduledDate: document.getElementById('notificationSchedule').value,
                sendEmail: document.getElementById('sendEmail').checked
            };

            if (!formData.type || !formData.title || !formData.message) {
                alert('Mohon lengkapi semua field yang diperlukan');
                return;
            }

            try {
                const response = await fetch('/api/notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createNotificationModal')).hide();
                    document.getElementById('notificationForm').reset();
                    await loadNotifications();
                    alert('Pemberitahuan berhasil dikirim!');
                } else {
                    alert('Gagal mengirim pemberitahuan');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('saveNotificationSettings').addEventListener('click', async function() {
            const settings = {
                leaveReminderEnabled: document.getElementById('leaveReminderEnabled').checked,
                leaveReminderDays: parseInt(document.getElementById('leaveReminderDays').value),
                birthdayReminderEnabled: document.getElementById('birthdayReminderEnabled').checked,
                birthdayReminderDays: parseInt(document.getElementById('birthdayReminderDays').value),
                performanceReminderEnabled: document.getElementById('performanceReminderEnabled').checked,
                performanceReminderDays: parseInt(document.getElementById('performanceReminderDays').value),
                emailNotificationsEnabled: document.getElementById('emailNotificationsEnabled').checked,
                emailFrequency: document.getElementById('emailFrequency').value
            };

            try {
                const response = await fetch('/api/notification-settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('Pengaturan berhasil disimpan!');
                } else {
                    alert('Gagal menyimpan pengaturan');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', async function() {
            const settings = {
                browserNotifications: document.getElementById('browserNotifications').checked,
                emailNotifications: document.getElementById('emailNotifications').checked,
                desktopNotifications: document.getElementById('desktopNotifications').checked,
                soundNotifications: document.getElementById('soundNotifications').checked
            };

            try {
                const response = await fetch('/api/user-notification-settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('notificationSettingsModal')).hide();
                    alert('Pengaturan berhasil disimpan!');
                } else {
                    alert('Gagal menyimpan pengaturan');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Placeholder functions for future implementation
        function viewNotification(id) { alert('Fitur lihat detail pemberitahuan akan segera hadir'); }
        function resendNotification(id) { alert('Fitur kirim ulang akan segera hadir'); }
        function editTemplate(id) { alert('Fitur edit template akan segera hadir'); }
        function useTemplate(id) { alert('Fitur gunakan template akan segera hadir'); }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadDepartments();
            await loadEmployees();
            await loadNotifications();
            await loadTemplates();
        });
    </script>
</body>
</html>
