<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ubah Password - Sistem HRM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-shield-lock"></i> Manajemen Password & Keamanan</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#securitySettingsModal">
          <i class="bi bi-gear"></i> Pengaturan Keamanan
        </button>
        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#passwordHistoryModal">
          <i class="bi bi-clock-history"></i> Riwayat Password
        </button>
      </div>
    </div>

    <!-- Security Status Overview -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card text-white bg-success">
          <div class="card-body">
            <h6 class="card-title">Status Password</h6>
            <h4 id="passwordStrength">Kuat</h4>
            <small>Terakhir diubah: 30 hari lalu</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-info">
          <div class="card-body">
            <h6 class="card-title">2FA Status</h6>
            <h4 id="twoFactorStatus">Aktif</h4>
            <small>Terakhir verifikasi: Hari ini</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-warning">
          <div class="card-body">
            <h6 class="card-title">Login Terakhir</h6>
            <h4 id="lastLogin">Hari ini</h4>
            <small>Dari: Jakarta, Indonesia</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-white bg-danger">
          <div class="card-body">
            <h6 class="card-title">Sesi Aktif</h6>
            <h4 id="activeSessions">2</h4>
            <small>Perangkat berbeda</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="passwordTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="change-password-tab" data-bs-toggle="tab" data-bs-target="#change-password" type="button" role="tab">Ubah Password</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="two-factor-tab" data-bs-toggle="tab" data-bs-target="#two-factor" type="button" role="tab">Two-Factor Auth</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="security-questions-tab" data-bs-toggle="tab" data-bs-target="#security-questions" type="button" role="tab">Pertanyaan Keamanan</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="login-activity-tab" data-bs-toggle="tab" data-bs-target="#login-activity" type="button" role="tab">Aktivitas Login</button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="passwordTabContent">
      <!-- Change Password Tab -->
      <div class="tab-pane fade show active" id="change-password" role="tabpanel">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5>Ubah Password</h5>
              </div>
              <div class="card-body">
                <form id="changePasswordForm">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label">Password Saat Ini *</label>
                    <div class="input-group">
                      <input type="password" class="form-control" id="currentPassword" required>
                      <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="newPassword" class="form-label">Password Baru *</label>
                    <div class="input-group">
                      <input type="password" class="form-control" id="newPassword" required>
                      <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                    <div class="password-strength mt-2">
                      <div class="progress" style="height: 5px;">
                        <div class="progress-bar" id="passwordStrengthBar" role="progressbar" style="width: 0%"></div>
                      </div>
                      <small class="text-muted mt-1" id="passwordStrengthText">Kekuatan password: -</small>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Konfirmasi Password Baru *</label>
                    <div class="input-group">
                      <input type="password" class="form-control" id="confirmPassword" required>
                      <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                    <div id="passwordMatchMessage" class="mt-1"></div>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="logoutAllDevices">
                      <label class="form-check-label" for="logoutAllDevices">
                        Keluar dari semua perangkat setelah mengubah password
                      </label>
                    </div>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="sendNotification">
                      <label class="form-check-label" for="sendNotification">
                        Kirim notifikasi perubahan password ke email saya
                      </label>
                    </div>
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                      <i class="bi bi-check-circle"></i> Ubah Password
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="generatePasswordBtn">
                      <i class="bi bi-dice-6"></i> Generate Password
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6>Kebijakan Password</h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled small">
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success"></i> Minimal 8 karakter
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success"></i> Kombinasi huruf besar & kecil
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success"></i> Minimal 1 angka
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-check-circle text-success"></i> Minimal 1 karakter khusus
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-x-circle text-danger"></i> Tidak boleh sama dengan 5 password sebelumnya
                  </li>
                  <li class="mb-2">
                    <i class="bi bi-clock text-warning"></i> Berlaku selama 90 hari
                  </li>
                </ul>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h6>Password Generator</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="generatedPassword" class="form-label">Password yang Dihasilkan</label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="generatedPassword" readonly>
                    <button class="btn btn-outline-secondary" type="button" id="copyGeneratedPassword">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="includeUppercase" checked>
                      <label class="form-check-label small" for="includeUppercase">A-Z</label>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="includeLowercase" checked>
                      <label class="form-check-label small" for="includeLowercase">a-z</label>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="includeNumbers" checked>
                      <label class="form-check-label small" for="includeNumbers">0-9</label>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="includeSymbols" checked>
                      <label class="form-check-label small" for="includeSymbols">!@#$</label>
                    </div>
                  </div>
                </div>
                <button class="btn btn-outline-primary btn-sm mt-2" id="regeneratePassword">
                  <i class="bi bi-arrow-clockwise"></i> Generate Baru
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Two-Factor Authentication Tab -->
      <div class="tab-pane fade" id="two-factor" role="tabpanel">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>Two-Factor Authentication (2FA)</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-success" id="twoFactorEnabledAlert" style="display: none;">
                  <i class="bi bi-shield-check"></i> 2FA telah diaktifkan untuk akun Anda
                </div>

                <div class="alert alert-warning" id="twoFactorDisabledAlert">
                  <i class="bi bi-shield-x"></i> 2FA belum diaktifkan. Aktifkan untuk keamanan ekstra.
                </div>

                <div id="twoFactorSetup" style="display: none;">
                  <h6>Langkah 1: Install Aplikasi Authenticator</h6>
                  <p class="small text-muted">Install aplikasi seperti Google Authenticator, Authy, atau Microsoft Authenticator di ponsel Anda.</p>

                  <h6>Langkah 2: Scan QR Code</h6>
                  <div class="text-center mb-3">
                    <div id="qrCodeContainer" class="border p-3 d-inline-block">
                      <i class="bi bi-qr-code" style="font-size: 100px;"></i>
                    </div>
                  </div>

                  <h6>Langkah 3: Masukkan Kode Verifikasi</h6>
                  <div class="mb-3">
                    <label for="twoFactorCode" class="form-label">Kode 6 digit dari aplikasi</label>
                    <input type="text" class="form-control" id="twoFactorCode" maxlength="6" pattern="[0-9]{6}">
                  </div>

                  <div class="d-flex gap-2">
                    <button class="btn btn-success" id="verifyTwoFactorBtn">
                      <i class="bi bi-check-circle"></i> Verifikasi & Aktifkan
                    </button>
                    <button class="btn btn-outline-secondary" id="cancelTwoFactorSetup">
                      Batal
                    </button>
                  </div>
                </div>

                <div id="twoFactorManagement">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Status 2FA:</span>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="twoFactorToggle">
                      <label class="form-check-label" for="twoFactorToggle"></label>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Backup Codes</label>
                    <p class="small text-muted">Simpan backup codes ini di tempat yang aman. Gunakan untuk mengakses akun jika kehilangan akses ke aplikasi authenticator.</p>
                    <button class="btn btn-outline-primary btn-sm" id="generateBackupCodes">
                      <i class="bi bi-key"></i> Generate Backup Codes
                    </button>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Riwayat 2FA</label>
                    <div id="twoFactorHistory" class="small">
                      <div class="d-flex justify-content-between py-1">
                        <span>Login berhasil - Chrome/Windows</span>
                        <small class="text-muted">2 jam lalu</small>
                      </div>
                      <div class="d-flex justify-content-between py-1">
                        <span>Login berhasil - Safari/iOS</span>
                        <small class="text-muted">1 hari lalu</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h6>Keamanan Tambahan</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <h6>Notifikasi Login</h6>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="notifyNewDevice" checked>
                    <label class="form-check-label small" for="notifyNewDevice">
                      Notifikasi login dari perangkat baru
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="notifySuspiciousActivity" checked>
                    <label class="form-check-label small" for="notifySuspiciousActivity">
                      Notifikasi aktivitas mencurigakan
                    </label>
                  </div>
                </div>

                <div class="mb-3">
                  <h6>Sesi & Perangkat</h6>
                  <button class="btn btn-outline-danger btn-sm mb-2" id="logoutAllSessions">
                    <i class="bi bi-box-arrow-right"></i> Keluar dari Semua Sesi
                  </button>
                  <div id="activeDevicesList" class="small">
                    <div class="d-flex justify-content-between align-items-center py-1">
                      <div>
                        <div>Chrome di Windows</div>
                        <small class="text-muted">Jakarta, Indonesia • Sekarang</small>
                      </div>
                      <span class="badge bg-success">Aktif</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center py-1">
                      <div>
                        <div>Safari di iPhone</div>
                        <small class="text-muted">Jakarta, Indonesia • 2 jam lalu</small>
                      </div>
                      <button class="btn btn-sm btn-outline-danger">Logout</button>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <h6>Recovery Options</h6>
                  <button class="btn btn-outline-primary btn-sm mb-2" id="setupRecoveryEmail">
                    <i class="bi bi-envelope"></i> Setup Email Recovery
                  </button>
                  <button class="btn btn-outline-primary btn-sm" id="setupRecoveryPhone">
                    <i class="bi bi-phone"></i> Setup SMS Recovery
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Questions Tab -->
      <div class="tab-pane fade" id="security-questions" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h5>Pertanyaan Keamanan</h5>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Pertanyaan keamanan digunakan untuk memulihkan akses akun jika lupa password atau kehilangan akses 2FA.
            </div>

            <form id="securityQuestionsForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="securityQuestion1" class="form-label">Pertanyaan 1 *</label>
                    <select class="form-select" id="securityQuestion1" required>
                      <option value="">Pilih pertanyaan</option>
                      <option value="mother">Siapa nama gadis ibu Anda?</option>
                      <option value="pet">Siapa nama hewan peliharaan pertama Anda?</option>
                      <option value="school">Di sekolah mana Anda lulus SD?</option>
                      <option value="city">Di kota mana Anda lahir?</option>
                      <option value="movie">Film favorit Anda saat kecil?</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="securityAnswer1" class="form-label">Jawaban 1 *</label>
                    <input type="text" class="form-control" id="securityAnswer1" required>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="securityQuestion2" class="form-label">Pertanyaan 2 *</label>
                    <select class="form-select" id="securityQuestion2" required>
                      <option value="">Pilih pertanyaan</option>
                      <option value="teacher">Siapa nama guru favorit Anda?</option>
                      <option value="book">Buku apa yang paling Anda sukai?</option>
                      <option value="hobby">Hobi apa yang Anda tekuni?</option>
                      <option value="friend">Siapa nama sahabat masa kecil Anda?</option>
                      <option value="color">Warna favorit Anda?</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="securityAnswer2" class="form-label">Jawaban 2 *</label>
                    <input type="text" class="form-control" id="securityAnswer2" required>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="securityQuestion3" class="form-label">Pertanyaan 3 *</label>
                    <select class="form-select" id="securityQuestion3" required>
                      <option value="">Pilih pertanyaan</option>
                      <option value="food">Makanan favorit Anda?</option>
                      <option value="sport">Olahraga apa yang Anda sukai?</option>
                      <option value="music">Band musik favorit Anda?</option>
                      <option value="place">Tempat wisata favorit Anda?</option>
                      <option value="dream">Apa impian Anda saat kecil?</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="securityAnswer3" class="form-label">Jawaban 3 *</label>
                    <input type="text" class="form-control" id="securityAnswer3" required>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="showAnswers">
                    <label class="form-check-label" for="showAnswers">
                      Tampilkan jawaban (untuk verifikasi)
                    </label>
                  </div>
                  <div class="mt-3">
                    <button type="button" class="btn btn-outline-info btn-sm" id="testSecurityQuestions">
                      <i class="bi bi-question-circle"></i> Test Pertanyaan
                    </button>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save"></i> Simpan Pertanyaan Keamanan
                </button>
                <button type="button" class="btn btn-outline-secondary" id="resetSecurityQuestions">
                  <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Login Activity Tab -->
      <div class="tab-pane fade" id="login-activity" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5>Aktivitas Login & Keamanan</h5>
              <div class="d-flex gap-2">
                <select class="form-select form-select-sm" id="activityFilter" style="width: auto;">
                  <option value="">Semua Aktivitas</option>
                  <option value="login">Login</option>
                  <option value="logout">Logout</option>
                  <option value="failed">Login Gagal</option>
                  <option value="password-change">Ubah Password</option>
                </select>
                <button class="btn btn-outline-danger btn-sm" id="clearActivityLog">
                  <i class="bi bi-trash"></i> Hapus Log
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Tanggal & Waktu</th>
                    <th>Aktivitas</th>
                    <th>Perangkat</th>
                    <th>Lokasi</th>
                    <th>IP Address</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="activityTableBody">
                  <tr>
                    <td>2025-01-15 14:30:25</td>
                    <td><i class="bi bi-box-arrow-in-right text-success"></i> Login berhasil</td>
                    <td>Chrome di Windows</td>
                    <td>Jakarta, Indonesia</td>
                    <td>192.168.1.100</td>
                    <td><span class="badge bg-success">Berhasil</span></td>
                  </tr>
                  <tr>
                    <td>2025-01-15 09:15:10</td>
                    <td><i class="bi bi-shield-check text-info"></i> Password diubah</td>
                    <td>Chrome di Windows</td>
                    <td>Jakarta, Indonesia</td>
                    <td>192.168.1.100</td>
                    <td><span class="badge bg-info">Berhasil</span></td>
                  </tr>
                  <tr>
                    <td>2025-01-14 16:45:33</td>
                    <td><i class="bi bi-box-arrow-in-right text-success"></i> Login berhasil</td>
                    <td>Safari di iPhone</td>
                    <td>Jakarta, Indonesia</td>
                    <td>192.168.1.101</td>
                    <td><span class="badge bg-success">Berhasil</span></td>
                  </tr>
                  <tr>
                    <td>2025-01-14 08:20:15</td>
                    <td><i class="bi bi-x-circle text-danger"></i> Login gagal</td>
                    <td>Firefox di Linux</td>
                    <td>Unknown</td>
                    <td>10.0.0.50</td>
                    <td><span class="badge bg-danger">Gagal</span></td>
                  </tr>
                  <tr>
                    <td>2025-01-13 11:30:45</td>
                    <td><i class="bi bi-box-arrow-right text-warning"></i> Logout</td>
                    <td>Chrome di Windows</td>
                    <td>Jakarta, Indonesia</td>
                    <td>192.168.1.100</td>
                    <td><span class="badge bg-secondary">Normal</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Settings Modal -->
  <div class="modal fade" id="securitySettingsModal" tabindex="-1" aria-labelledby="securitySettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="securitySettingsModalLabel">Pengaturan Keamanan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Password Policy</h6>
              <div class="mb-3">
                <label for="passwordExpiryDays" class="form-label">Masa Berlaku Password (hari)</label>
                <input type="number" class="form-control" id="passwordExpiryDays" value="90" min="30" max="365">
              </div>

              <div class="mb-3">
                <label for="passwordHistoryCount" class="form-label">Jumlah Password yang Diingat</label>
                <input type="number" class="form-control" id="passwordHistoryCount" value="5" min="1" max="10">
              </div>

              <div class="mb-3">
                <label for="minPasswordLength" class="form-label">Panjang Minimum Password</label>
                <input type="number" class="form-control" id="minPasswordLength" value="8" min="6" max="20">
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="requireSpecialChars" checked>
                <label class="form-check-label" for="requireSpecialChars">
                  Wajib karakter khusus (!@#$%^&*)
                </label>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="requireNumbers" checked>
                <label class="form-check-label" for="requireNumbers">
                  Wajib angka (0-9)
                </label>
              </div>
            </div>

            <div class="col-md-6">
              <h6>Session Management</h6>
              <div class="mb-3">
                <label for="sessionTimeout" class="form-label">Timeout Sesi (menit)</label>
                <input type="number" class="form-control" id="sessionTimeout" value="30" min="5" max="480">
              </div>

              <div class="mb-3">
                <label for="maxLoginAttempts" class="form-label">Maksimal Percobaan Login</label>
                <input type="number" class="form-control" id="maxLoginAttempts" value="5" min="3" max="10">
              </div>

              <div class="mb-3">
                <label for="lockoutDuration" class="form-label">Durasi Lockout (menit)</label>
                <input type="number" class="form-control" id="lockoutDuration" value="15" min="5" max="60">
              </div>

              <h6>Advanced Security</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enableBruteForceProtection" checked>
                <label class="form-check-label" for="enableBruteForceProtection">
                  Perlindungan brute force
                </label>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enableGeoBlocking">
                <label class="form-check-label" for="enableGeoBlocking">
                  Blokir berdasarkan lokasi
                </label>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="enableIpWhitelist">
                <label class="form-check-label" for="enableIpWhitelist">
                  Whitelist IP
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" class="btn btn-primary" id="saveSecuritySettingsBtn">Simpan Pengaturan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Password History Modal -->
  <div class="modal fade" id="passwordHistoryModal" tabindex="-1" aria-labelledby="passwordHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="passwordHistoryModalLabel">Riwayat Perubahan Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Riwayat password menunjukkan kapan dan bagaimana password Anda diubah. Password tersimpan dalam bentuk hash yang aman.
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Tanggal Perubahan</th>
                  <th>Metode Perubahan</th>
                  <th>IP Address</th>
                  <th>Browser/Perangkat</th>
                  <th>Status</th>
                  <th>Kekuatan Password</th>
                </tr>
              </thead>
              <tbody id="passwordHistoryTableBody">
                <tr>
                  <td>2025-01-15 14:30:25</td>
                  <td>Manual change</td>
                  <td>192.168.1.100</td>
                  <td>Chrome/Windows</td>
                  <td><span class="badge bg-success">Berhasil</span></td>
                  <td><span class="badge bg-success">Kuat</span></td>
                </tr>
                <tr>
                  <td>2024-12-15 09:15:10</td>
                  <td>Admin reset</td>
                  <td>192.168.1.100</td>
                  <td>Chrome/Windows</td>
                  <td><span class="badge bg-success">Berhasil</span></td>
                  <td><span class="badge bg-warning">Sedang</span></td>
                </tr>
                <tr>
                  <td>2024-11-15 11:45:33</td>
                  <td>Password reset</td>
                  <td>192.168.1.101</td>
                  <td>Safari/iPhone</td>
                  <td><span class="badge bg-success">Berhasil</span></td>
                  <td><span class="badge bg-success">Kuat</span></td>
                </tr>
                <tr>
                  <td>2024-10-15 08:20:15</td>
                  <td>Manual change</td>
                  <td>192.168.1.100</td>
                  <td>Chrome/Windows</td>
                  <td><span class="badge bg-success">Berhasil</span></td>
                  <td><span class="badge bg-danger">Lemah</span></td>
                </tr>
                <tr>
                  <td>2024-09-15 16:30:45</td>
                  <td>System generated</td>
                  <td>192.168.1.100</td>
                  <td>Chrome/Windows</td>
                  <td><span class="badge bg-success">Berhasil</span></td>
                  <td><span class="badge bg-success">Kuat</span></td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3">
            <h6>Statistik Password</h6>
            <div class="row">
              <div class="col-md-3">
                <div class="text-center">
                  <div class="h4 text-success">4</div>
                  <small class="text-muted">Password Kuat</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <div class="h4 text-warning">1</div>
                  <small class="text-muted">Password Sedang</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <div class="h4 text-danger">1</div>
                  <small class="text-muted">Password Lemah</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <div class="h4 text-primary">5</div>
                  <small class="text-muted">Total Perubahan</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger" id="clearPasswordHistoryBtn">Hapus Riwayat</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function getToken() { return localStorage.getItem('token') || ''; }

    let passwordHistory = [];
    let securitySettings = {};
    let twoFactorEnabled = false;

    // Logout functionality
    document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    async function loadSecurityOverview() {
      try {
        const response = await fetch('/api/security/overview', {
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        if (response.ok) {
          const data = await response.json();
          updateSecurityOverview(data);
        }
      } catch (error) {
        console.error('Error loading security overview:', error);
      }
    }

    function updateSecurityOverview(data) {
      document.getElementById('passwordStrength').textContent = data.passwordStrength || 'Kuat';
      document.getElementById('twoFactorStatus').textContent = data.twoFactorEnabled ? 'Aktif' : 'Tidak Aktif';
      document.getElementById('lastLogin').textContent = data.lastLogin || 'Hari ini';
      document.getElementById('activeSessions').textContent = data.activeSessions || 1;

      twoFactorEnabled = data.twoFactorEnabled || false;
      updateTwoFactorUI();
    }

    function updateTwoFactorUI() {
      const enabledAlert = document.getElementById('twoFactorEnabledAlert');
      const disabledAlert = document.getElementById('twoFactorDisabledAlert');
      const setupDiv = document.getElementById('twoFactorSetup');
      const managementDiv = document.getElementById('twoFactorManagement');
      const toggle = document.getElementById('twoFactorToggle');

      if (twoFactorEnabled) {
        enabledAlert.style.display = 'block';
        disabledAlert.style.display = 'none';
        setupDiv.style.display = 'none';
        managementDiv.style.display = 'block';
        toggle.checked = true;
      } else {
        enabledAlert.style.display = 'none';
        disabledAlert.style.display = 'block';
        setupDiv.style.display = 'none';
        managementDiv.style.display = 'block';
        toggle.checked = false;
      }
    }

    // Password visibility toggles
    document.getElementById('toggleCurrentPassword').addEventListener('click', function() {
      const input = document.getElementById('currentPassword');
      const icon = this.querySelector('i');
      togglePasswordVisibility(input, icon);
    });

    document.getElementById('toggleNewPassword').addEventListener('click', function() {
      const input = document.getElementById('newPassword');
      const icon = this.querySelector('i');
      togglePasswordVisibility(input, icon);
    });

    document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
      const input = document.getElementById('confirmPassword');
      const icon = this.querySelector('i');
      togglePasswordVisibility(input, icon);
    });

    function togglePasswordVisibility(input, icon) {
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'bi bi-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'bi bi-eye';
      }
    }

    // Password strength checker
    document.getElementById('newPassword').addEventListener('input', function() {
      const password = this.value;
      const strength = checkPasswordStrength(password);
      updatePasswordStrengthIndicator(strength);
    });

    function checkPasswordStrength(password) {
      let score = 0;
      const checks = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        numbers: /\d/.test(password),
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
      };

      score += checks.length ? 1 : 0;
      score += checks.uppercase ? 1 : 0;
      score += checks.lowercase ? 1 : 0;
      score += checks.numbers ? 1 : 0;
      score += checks.special ? 1 : 0;

      return {
        score: score,
        checks: checks,
        strength: score <= 2 ? 'Lemah' : score <= 3 ? 'Sedang' : score <= 4 ? 'Kuat' : 'Sangat Kuat',
        percentage: (score / 5) * 100
      };
    }

    function updatePasswordStrengthIndicator(strength) {
      const bar = document.getElementById('passwordStrengthBar');
      const text = document.getElementById('passwordStrengthText');

      bar.style.width = strength.percentage + '%';

      if (strength.score <= 2) {
        bar.className = 'progress-bar bg-danger';
        text.textContent = 'Kekuatan password: Lemah';
      } else if (strength.score <= 3) {
        bar.className = 'progress-bar bg-warning';
        text.textContent = 'Kekuatan password: Sedang';
      } else if (strength.score <= 4) {
        bar.className = 'progress-bar bg-info';
        text.textContent = 'Kekuatan password: Kuat';
      } else {
        bar.className = 'progress-bar bg-success';
        text.textContent = 'Kekuatan password: Sangat Kuat';
      }
    }

    // Password confirmation checker
    document.getElementById('confirmPassword').addEventListener('input', function() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = this.value;
      const messageDiv = document.getElementById('passwordMatchMessage');

      if (confirmPassword === '') {
        messageDiv.innerHTML = '';
        return;
      }

      if (newPassword === confirmPassword) {
        messageDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Password cocok</small>';
      } else {
        messageDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> Password tidak cocok</small>';
      }
    });

    // Password generator
    document.getElementById('generatePasswordBtn').addEventListener('click', function() {
      const generatedPassword = generateSecurePassword();
      document.getElementById('newPassword').value = generatedPassword;
      document.getElementById('generatedPassword').value = generatedPassword;

      // Trigger password strength check
      document.getElementById('newPassword').dispatchEvent(new Event('input'));
    });

    document.getElementById('regeneratePassword').addEventListener('click', function() {
      const generatedPassword = generateSecurePassword();
      document.getElementById('generatedPassword').value = generatedPassword;
    });

    function generateSecurePassword() {
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const lowercase = 'abcdefghijklmnopqrstuvwxyz';
      const numbers = '0123456789';
      const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';

      let chars = '';
      if (document.getElementById('includeUppercase').checked) chars += uppercase;
      if (document.getElementById('includeLowercase').checked) chars += lowercase;
      if (document.getElementById('includeNumbers').checked) chars += numbers;
      if (document.getElementById('includeSymbols').checked) chars += symbols;

      if (chars === '') chars = lowercase + numbers; // fallback

      let password = '';
      for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }

      return password;
    }

    document.getElementById('copyGeneratedPassword').addEventListener('click', function() {
      const password = document.getElementById('generatedPassword').value;
      navigator.clipboard.writeText(password).then(() => {
        // Show success feedback
        const originalIcon = this.innerHTML;
        this.innerHTML = '<i class="bi bi-check-circle"></i>';
        setTimeout(() => {
          this.innerHTML = originalIcon;
        }, 2000);
      });
    });

    // Change password form submission
    document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const logoutAllDevices = document.getElementById('logoutAllDevices').checked;
      const sendNotification = document.getElementById('sendNotification').checked;

      // Validation
      if (newPassword !== confirmPassword) {
        alert('Password baru dan konfirmasi password tidak cocok');
        return;
      }

      if (newPassword.length < 8) {
        alert('Password baru harus minimal 8 karakter');
        return;
      }

      const strength = checkPasswordStrength(newPassword);
      if (strength.score < 3) {
        alert('Password terlalu lemah. Gunakan kombinasi huruf besar, kecil, angka, dan simbol.');
        return;
      }

      try {
        const response = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
          },
          body: JSON.stringify({
            currentPassword: currentPassword,
            newPassword: newPassword,
            logoutAllDevices: logoutAllDevices,
            sendNotification: sendNotification
          })
        });

        if (response.ok) {
          alert('Password berhasil diubah!');
          document.getElementById('changePasswordForm').reset();
          updatePasswordStrengthIndicator({ score: 0, percentage: 0 });

          if (logoutAllDevices) {
            alert('Anda akan logout dari semua perangkat. Silakan login kembali.');
            localStorage.removeItem('token');
            window.location.href = '/login';
          }
        } else {
          const error = await response.text();
          alert(`Gagal mengubah password: ${error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    // Two-factor authentication
    document.getElementById('twoFactorToggle').addEventListener('change', async function() {
      if (this.checked && !twoFactorEnabled) {
        // Show setup
        document.getElementById('twoFactorSetup').style.display = 'block';
        document.getElementById('twoFactorManagement').style.display = 'none';
      } else if (!this.checked && twoFactorEnabled) {
        // Disable 2FA
        if (confirm('Apakah Anda yakin ingin menonaktifkan 2FA?')) {
          try {
            const response = await fetch('/api/auth/disable-2fa', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + getToken() }
            });

            if (response.ok) {
              twoFactorEnabled = false;
              updateTwoFactorUI();
              alert('2FA berhasil dinonaktifkan');
            } else {
              this.checked = true;
              alert('Gagal menonaktifkan 2FA');
            }
          } catch (error) {
            this.checked = true;
            alert(`Error: ${error.message}`);
          }
        } else {
          this.checked = true;
        }
      }
    });

    document.getElementById('verifyTwoFactorBtn').addEventListener('click', async function() {
      const code = document.getElementById('twoFactorCode').value;

      if (!code || code.length !== 6) {
        alert('Masukkan kode 6 digit yang valid');
        return;
      }

      try {
        const response = await fetch('/api/auth/verify-2fa', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
          },
          body: JSON.stringify({ code: code })
        });

        if (response.ok) {
          twoFactorEnabled = true;
          updateTwoFactorUI();
          alert('2FA berhasil diaktifkan!');
        } else {
          alert('Kode verifikasi tidak valid');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    document.getElementById('cancelTwoFactorSetup').addEventListener('click', function() {
      document.getElementById('twoFactorToggle').checked = false;
      document.getElementById('twoFactorSetup').style.display = 'none';
      document.getElementById('twoFactorManagement').style.display = 'block';
    });

    document.getElementById('generateBackupCodes').addEventListener('click', async function() {
      try {
        const response = await fetch('/api/auth/generate-backup-codes', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });

        if (response.ok) {
          const data = await response.json();
          alert(`Backup codes berhasil dibuat:\n\n${data.codes.join('\n')}\n\nSimpan codes ini di tempat yang aman!`);
        } else {
          alert('Gagal membuat backup codes');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    // Security questions
    document.getElementById('securityQuestionsForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const questions = [
        {
          question: document.getElementById('securityQuestion1').value,
          answer: document.getElementById('securityAnswer1').value
        },
        {
          question: document.getElementById('securityQuestion2').value,
          answer: document.getElementById('securityAnswer2').value
        },
        {
          question: document.getElementById('securityQuestion3').value,
          answer: document.getElementById('securityAnswer3').value
        }
      ];

      // Validation
      if (questions.some(q => !q.question || !q.answer)) {
        alert('Mohon lengkapi semua pertanyaan dan jawaban');
        return;
      }

      try {
        const response = await fetch('/api/auth/security-questions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
          },
          body: JSON.stringify({ questions: questions })
        });

        if (response.ok) {
          alert('Pertanyaan keamanan berhasil disimpan!');
          document.getElementById('securityQuestionsForm').reset();
        } else {
          alert('Gagal menyimpan pertanyaan keamanan');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    document.getElementById('resetSecurityQuestions').addEventListener('click', function() {
      if (confirm('Apakah Anda yakin ingin mereset pertanyaan keamanan?')) {
        document.getElementById('securityQuestionsForm').reset();
      }
    });

    document.getElementById('testSecurityQuestions').addEventListener('click', function() {
      alert('Fitur test pertanyaan keamanan akan segera hadir');
    });

    // Security settings
    document.getElementById('saveSecuritySettingsBtn').addEventListener('click', async function() {
      const settings = {
        passwordExpiryDays: parseInt(document.getElementById('passwordExpiryDays').value),
        passwordHistoryCount: parseInt(document.getElementById('passwordHistoryCount').value),
        minPasswordLength: parseInt(document.getElementById('minPasswordLength').value),
        requireSpecialChars: document.getElementById('requireSpecialChars').checked,
        requireNumbers: document.getElementById('requireNumbers').checked,
        sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
        maxLoginAttempts: parseInt(document.getElementById('maxLoginAttempts').value),
        lockoutDuration: parseInt(document.getElementById('lockoutDuration').value),
        enableBruteForceProtection: document.getElementById('enableBruteForceProtection').checked,
        enableGeoBlocking: document.getElementById('enableGeoBlocking').checked,
        enableIpWhitelist: document.getElementById('enableIpWhitelist').checked
      };

      try {
        const response = await fetch('/api/security/settings', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
          },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          bootstrap.Modal.getInstance(document.getElementById('securitySettingsModal')).hide();
          alert('Pengaturan keamanan berhasil disimpan!');
        } else {
          alert('Gagal menyimpan pengaturan keamanan');
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    });

    document.getElementById('clearPasswordHistoryBtn').addEventListener('click', function() {
      if (confirm('Apakah Anda yakin ingin menghapus semua riwayat password? Tindakan ini tidak dapat dibatalkan.')) {
        alert('Fitur hapus riwayat password akan segera hadir');
      }
    });

    // Activity filter
    document.getElementById('activityFilter').addEventListener('change', function() {
      const filter = this.value;
      const rows = document.querySelectorAll('#activityTableBody tr');

      rows.forEach(row => {
        if (!filter) {
          row.style.display = '';
          return;
        }

        const activityText = row.cells[1].textContent.toLowerCase();
        if (activityText.includes(filter)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });

    document.getElementById('clearActivityLog').addEventListener('click', function() {
      if (confirm('Apakah Anda yakin ingin menghapus log aktivitas?')) {
        alert('Fitur hapus log aktivitas akan segera hadir');
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await loadSecurityOverview();
    });
  </script>
</body>
</html>
